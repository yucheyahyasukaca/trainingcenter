# üîí Security Assessment & Pentest Preparation Report
## GARUDA-21 Training Center Application

**Tanggal Assessment:** $(date)  
**Versi Aplikasi:** 2.0.0  
**Tech Stack:** Next.js 14 + TypeScript + Supabase (PostgreSQL)  
**Status:** ‚ö†Ô∏è **TIDAK SIAP UNTUK PENETRATION TESTING**

---

## üìã Executive Summary

Setelah melakukan analisis mendalam terhadap kode aplikasi, ditemukan **18 kerentanan KRITIS** dan **25 kerentanan MEDIUM-HIGH** yang harus diperbaiki sebelum penetration testing. Aplikasi saat ini memiliki risiko keamanan yang sangat tinggi dan dapat dengan mudah dieksploitasi oleh attacker.

### Risk Score: üî¥ **9.2/10 (CRITICAL)**

**Rekomendasi:** **JANGAN lakukan penetration testing di production** sebelum memperbaiki semua kerentanan critical. Lakukan perbaikan di staging environment terlebih dahulu.

---

## üö® KERENTANAN KRITIS (CRITICAL VULNERABILITIES)

### 1. ‚ö†Ô∏è **ADMIN API ROUTES TIDAK ADA AUTHENTICATION** 
**Severity:** üî¥ CRITICAL  
**CVSS Score:** 9.8  
**CWE-306:** Missing Authentication for Critical Function

**Lokasi:**
- `app/api/admin/participants/reset-password/route.ts` - Line 5-48
- `app/api/admin/certificate-templates/route.ts` - Line 5-75, 78-206
- `app/api/admin/certificates/route.ts`
- `app/api/admin/referral-policies/route.ts`
- `app/api/admin/short-links/route.ts`

**Masalah:**
```typescript
// ‚ùå TIDAK ADA VALIDASI APAPUN!
export async function POST(request: NextRequest) {
  const { userId } = await request.json()
  const supabaseAdmin = getSupabaseAdmin()
  const defaultPassword = 'Garuda-21.com'
  
  // Siapapun bisa reset password user lain!
  await supabaseAdmin.auth.admin.updateUserById(userId, {
    password: defaultPassword
  })
}
```

**Impact:**
- ‚úÖ Siapapun dapat mengakses semua endpoint admin
- ‚úÖ Account takeover massal (reset password semua user)
- ‚úÖ Akses penuh ke database (create/update/delete)
- ‚úÖ Bypass semua authorization

**Proof of Concept:**
```bash
# Attack tanpa authentication
curl -X POST https://garuda-21.com/api/admin/participants/reset-password \
  -H "Content-Type: application/json" \
  -d '{"userId": "victim-user-id"}'

# Response: Password berhasil direset ke "Garuda-21.com"
```

**Fix Priority:** üî¥ **IMMEDIATE** (Fix dalam 24 jam)

---

### 2. ‚ö†Ô∏è **HARDCODED DEFAULT PASSWORD**
**Severity:** üî¥ CRITICAL  
**CVSS Score:** 9.1  
**CWE-798:** Use of Hard-coded Credentials

**Lokasi:**
- `app/api/admin/participants/reset-password/route.ts` - Line 19

**Masalah:**
```typescript
// ‚ùå Password hardcoded dan predictable!
const defaultPassword = 'Garuda-21.com'
```

**Impact:**
- ‚úÖ Attacker tahu password default setelah reset
- ‚úÖ Brute force attack mudah dilakukan
- ‚úÖ Account takeover massal

**Fix Priority:** üî¥ **IMMEDIATE**

---

### 3. ‚ö†Ô∏è **FILE UPLOAD TIDAK ADA VALIDASI**
**Severity:** üî¥ CRITICAL  
**CVSS Score:** 9.3  
**CWE-434:** Unrestricted Upload of File with Dangerous Type

**Lokasi:**
- `app/api/forum/upload/route.ts` - Line 6-103
- `app/api/assignment/upload/route.ts`
- `app/api/admin/certificate-templates/route.ts` (PDF upload)

**Masalah:**
```typescript
// ‚ùå TIDAK ADA VALIDASI!
export async function POST(req: NextRequest) {
  const file = form.get('file') as File | null
  
  // Tidak ada validasi:
  // - File type
  // - File size
  // - Magic bytes
  // - Authentication
  // - Path traversal protection
  
  const normalizedFileName = file.name
    .replace(/[^a-zA-Z0-9.-]/g, '_')
    .toLowerCase()
  
  // Trust user input untuk Content-Type!
  await supabase.storage.from(bucketId).upload(finalPath, arrayBuffer, {
    contentType: file.type || 'application/octet-stream', // ‚ùå
    upsert: true, // ‚ùå Allow overwrite
  })
}
```

**Impact:**
- ‚úÖ Upload shell/malware (PHP, JSP, ASPX, EXE)
- ‚úÖ Path traversal attack (`../../../etc/passwd`)
- ‚úÖ DoS via file besar (10GB+)
- ‚úÖ Stored XSS via SVG/HTML upload
- ‚úÖ MIME type confusion attack

**Proof of Concept:**
```bash
# Upload PHP shell
curl -X POST https://garuda-21.com/api/forum/upload \
  -F "file=@shell.php" \
  -F "path=../../../../public/shell.php"

# Upload file besar (DoS)
dd if=/dev/zero of=large.bin bs=1M count=10000
curl -X POST https://garuda-21.com/api/forum/upload \
  -F "file=@large.bin"
```

**Fix Priority:** üî¥ **IMMEDIATE**

---

### 4. ‚ö†Ô∏è **MIDDLEWARE DISABLED**
**Severity:** üî¥ CRITICAL  
**CVSS Score:** 9.5  
**CWE-284:** Improper Access Control

**Lokasi:**
- `middleware.ts` - Line 25-40

**Masalah:**
```typescript
export async function middleware(request: NextRequest) {
  // ‚ùå MIDDLEWARE TIDAK MELAKUKAN APAPUN!
  // Semua route bisa diakses tanpa authentication
  
  return NextResponse.next() // Always allow
}
```

**Impact:**
- ‚úÖ Semua protected pages bisa diakses tanpa login
- ‚úÖ Admin dashboard accessible tanpa authentication
- ‚úÖ User data bisa diakses langsung
- ‚úÖ Bypass semua authorization

**Fix Priority:** üî¥ **IMMEDIATE**

---

### 5. ‚ö†Ô∏è **ROW LEVEL SECURITY (RLS) DISABLED**
**Severity:** üî¥ CRITICAL  
**CVSS Score:** 9.7  
**CWE-862:** Missing Authorization

**Lokasi:**
- `supabase/disable-all-rls.sql` - File ini menunjukkan RLS dinonaktifkan

**Masalah:**
```sql
-- ‚ùå RLS DISABLED DI SEMUA TABEL!
ALTER TABLE public.user_profiles DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.programs DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.participants DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.enrollments DISABLE ROW LEVEL SECURITY;
-- ... dll
```

**Impact:**
- ‚úÖ User bisa akses data user lain (IDOR)
- ‚úÖ Data leakage masif
- ‚úÖ Tidak ada data isolation
- ‚úÖ Bypass authorization di database level

**Proof of Concept:**
```typescript
// User A bisa akses data User B
const { data } = await supabase
  .from('user_profiles')
  .select('*')
  .eq('id', 'user-b-id') // ‚úÖ Bisa akses!

const { data: enrollments } = await supabase
  .from('enrollments')
  .select('*')
  .eq('participant_id', 'other-user-id') // ‚úÖ Bisa akses!
```

**Fix Priority:** üî¥ **IMMEDIATE**

---

### 6. ‚ö†Ô∏è **SENSITIVE DATA IN LOGS**
**Severity:** üî¥ CRITICAL  
**CVSS Score:** 8.5  
**CWE-532:** Insertion of Sensitive Information into Log File

**Lokasi:**
- `lib/supabase-admin.ts` - Line 27-29
- `lib/supabase.ts` - Line 9-12
- `app/api/forum/upload/route.ts` - Line 33

**Masalah:**
```typescript
// ‚ùå Log sensitive keys!
console.log('‚úì Service role key:', supabaseKey.substring(0, 20) + '...')
console.log('Service Key:', serviceKey ? `${serviceKey.substring(0, 10)}...` : 'Missing')
console.log('Service Key exists:', !!supabaseServiceKey)
```

**Impact:**
- ‚úÖ API keys bisa leak via logs
- ‚úÖ Credentials exposure
- ‚úÖ Information disclosure

**Fix Priority:** üü† **HIGH** (Fix dalam 48 jam)

---

### 7. ‚ö†Ô∏è **MASS ASSIGNMENT VULNERABILITY**
**Severity:** üî¥ CRITICAL  
**CVSS Score:** 8.8  
**CWE-915:** Improperly Controlled Modification of Dynamically-Determined Object Attributes

**Lokasi:**
- `app/api/signup-without-email-confirmation/route.ts` - Line 56-65

**Masalah:**
```typescript
// ‚ùå Bisa inject field tambahan!
export async function POST(request: NextRequest) {
  const { email, password, fullName } = await request.json()
  
  // Attacker bisa kirim:
  // { email: "...", password: "...", fullName: "...", role: "admin" }
  
  await supabase.from('user_profiles').insert({
    id: authData.user.id,
    email: authData.user.email!,
    full_name: fullName,
    role: 'user' // ‚úÖ Hardcoded, tapi bisa di-bypass dengan mass assignment
  })
}
```

**Impact:**
- ‚úÖ Privilege escalation (set role = 'admin')
- ‚úÖ Modify protected fields
- ‚úÖ Bypass business logic

**Fix Priority:** üî¥ **IMMEDIATE**

---

### 8. ‚ö†Ô∏è **IDOR (Insecure Direct Object Reference)**
**Severity:** üî¥ CRITICAL  
**CVSS Score:** 8.9  
**CWE-639:** Authorization Bypass Through User-Controlled Key

**Lokasi:**
- `app/api/tickets/[id]/messages/route.ts` - Line 43-66
- `app/api/certificate/[certificateNumber]/route.ts`
- `app/api/enrollments/*`

**Masalah:**
```typescript
// ‚ùå Validation bisa di-bypass!
export async function POST(request, { params }) {
  const ticketId = params.id // User controlled
  
  // Minimal validation
  if (!isUserAdmin) {
    const userEmail = user?.email || sender_email
    // ‚ùå Bisa manipulasi sender_email!
    if (ticket.email !== userEmail && ticket.user_id !== user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 })
    }
  }
}
```

**Impact:**
- ‚úÖ Akses data user lain
- ‚úÖ Modifikasi resource yang bukan milik user
- ‚úÖ Data leakage

**Fix Priority:** üî¥ **IMMEDIATE**

---

### 9. ‚ö†Ô∏è **NO RATE LIMITING**
**Severity:** üü† HIGH  
**CVSS Score:** 7.5  
**CWE-770:** Allocation of Resources Without Limits or Throttling

**Lokasi:**
- Semua API routes tidak ada rate limiting

**Masalah:**
- ‚ùå Tidak ada rate limiting di login endpoint
- ‚ùå Tidak ada rate limiting di registration
- ‚ùå Tidak ada rate limiting di password reset
- ‚ùå Tidak ada rate limiting di API calls

**Impact:**
- ‚úÖ Brute force attacks
- ‚úÖ DDoS attacks
- ‚úÖ API abuse
- ‚úÖ Resource exhaustion

**Fix Priority:** üü† **HIGH** (Fix dalam 1 minggu)

---

### 10. ‚ö†Ô∏è **NO CSRF PROTECTION**
**Severity:** üü† HIGH  
**CVSS Score:** 7.2  
**CWE-352:** Cross-Site Request Forgery

**Masalah:**
- ‚ùå Tidak ada CSRF token validation
- ‚ùå Tidak ada SameSite cookie protection
- ‚ùå State-changing operations vulnerable

**Impact:**
- ‚úÖ CSRF attacks
- ‚úÖ Unauthorized actions
- ‚úÖ Account takeover

**Fix Priority:** üü† **HIGH**

---

### 11. ‚ö†Ô∏è **MISSING SECURITY HEADERS**
**Severity:** üü† HIGH  
**CVSS Score:** 6.8  
**CWE-693:** Protection Mechanism Failure

**Lokasi:**
- `next.config.js` - Tidak ada security headers

**Masalah:**
```javascript
// ‚ùå Tidak ada security headers!
const nextConfig = {
  reactStrictMode: true,
  // Tidak ada headers() function
}
```

**Missing Headers:**
- ‚ùå Strict-Transport-Security (HSTS)
- ‚ùå X-Frame-Options
- ‚ùå X-Content-Type-Options
- ‚ùå Content-Security-Policy (CSP)
- ‚ùå X-XSS-Protection
- ‚ùå Referrer-Policy
- ‚ùå Permissions-Policy

**Impact:**
- ‚úÖ Clickjacking attacks
- ‚úÖ XSS attacks
- ‚úÖ MIME type confusion
- ‚úÖ Information leakage

**Fix Priority:** üü† **HIGH**

---

### 12. ‚ö†Ô∏è **XSS VULNERABILITIES**
**Severity:** üü† HIGH  
**CVSS Score:** 7.8  
**CWE-79:** Improper Neutralization of Input During Web Page Generation

**Lokasi:**
- Email templates (user input tidak di-sanitize)
- Forum posts
- Certificate fields
- User profile fields

**Masalah:**
```typescript
// ‚ùå Direct interpolation tanpa sanitization!
const html = `
  <p>Halo <strong>${participantName}</strong></p>
  <p>${programDescription}</p>
`
// participantName bisa berisi: <script>alert('XSS')</script>
```

**Impact:**
- ‚úÖ Stored XSS
- ‚úÖ Cookie theft
- ‚úÖ Session hijacking
- ‚úÖ Phishing attacks

**Fix Priority:** üü† **HIGH**

---

### 13. ‚ö†Ô∏è **NO INPUT VALIDATION**
**Severity:** üü† HIGH  
**CVSS Score:** 7.5  
**CWE-20:** Improper Input Validation

**Masalah:**
- ‚ùå Tidak ada schema validation (Zod/Yup)
- ‚ùå Tidak ada sanitization
- ‚ùå Tidak ada type checking
- ‚ùå Trust user input

**Impact:**
- ‚úÖ SQL Injection (potensial)
- ‚úÖ XSS
- ‚úÖ Command Injection
- ‚úÖ Path Traversal

**Fix Priority:** üü† **HIGH**

---

### 14. ‚ö†Ô∏è **WEAK PASSWORD POLICY**
**Severity:** üü° MEDIUM  
**CVSS Score:** 5.3  
**CWE-521:** Weak Password Requirements

**Masalah:**
- ‚ùå Tidak ada password complexity requirement
- ‚ùå Tidak ada password length minimum enforcement
- ‚ùå Tidak ada password history
- ‚ùå Tidak ada account lockout

**Impact:**
- ‚úÖ Brute force attacks
- ‚úÖ Weak passwords
- ‚úÖ Account compromise

**Fix Priority:** üü° **MEDIUM**

---

### 15. ‚ö†Ô∏è **NO AUDIT LOGGING**
**Severity:** üü° MEDIUM  
**CVSS Score:** 5.5  
**CWE-778:** Insufficient Logging

**Masalah:**
- ‚ùå Tidak ada audit log untuk sensitive operations
- ‚ùå Tidak ada tracking untuk admin actions
- ‚ùå Tidak ada monitoring untuk suspicious activities

**Impact:**
- ‚úÖ Tidak bisa detect attacks
- ‚úÖ Tidak bisa forensic analysis
- ‚úÖ Compliance issues

**Fix Priority:** üü° **MEDIUM**

---

## üîß REKOMENDASI PERBAIKAN PRIORITAS TINGGI

### Phase 1: Critical Fixes (1-2 Hari) üî¥

#### Fix #1: Implement API Authentication Middleware

**File:** `lib/api-auth.ts` (NEW)

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createServerClient } from '@/lib/supabase-server'

export interface AuthResult {
  user: any
  profile: any
}

export async function validateAuth(request: NextRequest): Promise<AuthResult> {
  const supabase = createServerClient()
  const { data: { user }, error } = await supabase.auth.getUser()
  
  if (error || !user) {
    throw new Error('Unauthorized')
  }
  
  const { data: profile } = await supabase
    .from('user_profiles')
    .select('*')
    .eq('id', user.id)
    .single()
  
  if (!profile) {
    throw new Error('Profile not found')
  }
  
  return { user, profile }
}

export async function validateAdmin(request: NextRequest): Promise<AuthResult> {
  const { user, profile } = await validateAuth(request)
  
  if (profile.role !== 'admin') {
    throw new Error('Forbidden: Admin access required')
  }
  
  return { user, profile }
}

export function withAdmin(
  handler: (req: NextRequest, auth: AuthResult) => Promise<NextResponse>
) {
  return async (req: NextRequest) => {
    try {
      const auth = await validateAdmin(req)
      return await handler(req, auth)
    } catch (error: any) {
      return NextResponse.json(
        { error: error.message },
        { status: error.message === 'Unauthorized' ? 401 : 403 }
      )
    }
  }
}
```

**Apply ke semua admin routes:**
```typescript
// app/api/admin/participants/reset-password/route.ts
import { withAdmin } from '@/lib/api-auth'

export const POST = withAdmin(async (request, auth) => {
  const { userId } = await request.json()
  
  // Generate secure random password
  const newPassword = crypto.randomBytes(16).toString('hex')
  
  const supabaseAdmin = getSupabaseAdmin()
  await supabaseAdmin.auth.admin.updateUserById(userId, {
    password: newPassword
  })
  
  // Send password via secure email (jangan return di response!)
  await sendPasswordResetEmail(userId, newPassword)
  
  return NextResponse.json({
    success: true,
    message: 'Password berhasil direset dan dikirim via email'
  })
})
```

#### Fix #2: File Upload Validation

**File:** `lib/file-validation.ts` (NEW)

```typescript
import crypto from 'crypto'

const ALLOWED_FILE_TYPES = {
  image: ['image/jpeg', 'image/png', 'image/webp', 'image/gif'],
  document: ['application/pdf'],
  video: ['video/mp4', 'video/webm']
}

const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB

const ALLOWED_EXTENSIONS = {
  image: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
  document: ['pdf'],
  video: ['mp4', 'webm']
}

export function validateFile(
  file: File,
  allowedCategory: 'image' | 'document' | 'video'
): { valid: boolean; error?: string } {
  // 1. Check file size
  if (file.size > MAX_FILE_SIZE) {
    return {
      valid: false,
      error: `File terlalu besar. Maksimal ${MAX_FILE_SIZE / 1024 / 1024}MB`
    }
  }
  
  // 2. Check MIME type
  if (!ALLOWED_FILE_TYPES[allowedCategory].includes(file.type)) {
    return {
      valid: false,
      error: `Tipe file tidak diizinkan. Diizinkan: ${ALLOWED_FILE_TYPES[allowedCategory].join(', ')}`
    }
  }
  
  // 3. Check extension
  const ext = file.name.split('.').pop()?.toLowerCase()
  if (!ext || !ALLOWED_EXTENSIONS[allowedCategory].includes(ext)) {
    return {
      valid: false,
      error: 'Ekstensi file tidak diizinkan'
    }
  }
  
  // 4. Generate secure filename (prevent path traversal)
  const secureFileName = `${crypto.randomUUID()}.${ext}`
  
  return { valid: true }
}

export function generateSecureFileName(originalName: string): string {
  const ext = originalName.split('.').pop()?.toLowerCase() || 'bin'
  return `${crypto.randomUUID()}.${ext}`
}
```

**Apply ke upload endpoints:**
```typescript
// app/api/forum/upload/route.ts
import { validateFile, generateSecureFileName } from '@/lib/file-validation'
import { validateAuth } from '@/lib/api-auth'

export async function POST(req: NextRequest) {
  try {
    // ‚úÖ Validate authentication
    const auth = await validateAuth(req)
    
    const form = await req.formData()
    const file = form.get('file') as File | null
    
    if (!file) {
      return NextResponse.json({ error: 'Missing file' }, { status: 400 })
    }
    
    // ‚úÖ Validate file
    const validation = validateFile(file, 'image')
    if (!validation.valid) {
      return NextResponse.json({ error: validation.error }, { status: 400 })
    }
    
    // ‚úÖ Generate secure filename
    const secureFileName = generateSecureFileName(file.name)
    const finalPath = `images/${Date.now()}_${secureFileName}`
    
    // Upload dengan Content-Type yang benar
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('forum-attachments')
      .upload(finalPath, arrayBuffer, {
        contentType: file.type, // ‚úÖ Trust validated type
        upsert: false, // ‚úÖ Prevent overwrite
      })
    
    // ... rest of code
  } catch (error: any) {
    if (error.message === 'Unauthorized') {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }
    // ... error handling
  }
}
```

#### Fix #3: Enable Middleware Authentication

**File:** `middleware.ts`

```typescript
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'
import { createServerClient } from '@/lib/supabase-server'

const publicRoutes = [
  '/',
  '/login',
  '/register',
  '/certificate/verify',
  '/certificate',
  '/about',
  '/contact',
  '/programs', // Public listing
]

const adminRoutes = [
  '/admin',
  '/dashboard/admin',
  '/statistics/admin',
]

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl

  // Skip middleware for API routes, static files, etc
  if (
    pathname.startsWith('/api/') ||
    pathname.startsWith('/_next/') ||
    pathname.startsWith('/favicon.ico')
  ) {
    return NextResponse.next()
  }

  // Check if route is public
  const isPublicRoute = publicRoutes.some(
    route => pathname === route || pathname.startsWith(route)
  )

  if (isPublicRoute) {
    return NextResponse.next()
  }

  // Create Supabase client
  const response = NextResponse.next()
  const supabase = createServerClient()

  // Get session
  const { data: { session }, error } = await supabase.auth.getSession()

  // Redirect to login if not authenticated
  if (!session) {
    const loginUrl = new URL('/login', request.url)
    loginUrl.searchParams.set('redirect', pathname)
    return NextResponse.redirect(loginUrl)
  }

  // Check admin access
  const isAdminRoute = adminRoutes.some(route => pathname.startsWith(route))
  
  if (isAdminRoute) {
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('role')
      .eq('id', session.user.id)
      .single()
    
    if (!profile || profile.role !== 'admin') {
      return NextResponse.redirect(new URL('/unauthorized', request.url))
    }
  }

  return response
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.png|.*\\.jpg|.*\\.jpeg|.*\\.gif|.*\\.svg).*)',
  ],
}
```

#### Fix #4: Enable RLS Policies

**File:** `supabase/enable-rls-policies.sql` (NEW)

```sql
-- Enable RLS on all critical tables
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.programs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.certificates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tickets ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ticket_messages ENABLE ROW LEVEL SECURITY;

-- User Profiles Policies
CREATE POLICY "Users can view own profile"
ON public.user_profiles FOR SELECT
TO authenticated
USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
ON public.user_profiles FOR UPDATE
TO authenticated
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

CREATE POLICY "Admins can view all profiles"
ON public.user_profiles FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.user_profiles
    WHERE id = auth.uid() AND role = 'admin'
  )
);

-- Participants Policies
CREATE POLICY "Users can view own participant data"
ON public.participants FOR SELECT
TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "Admins can manage all participants"
ON public.participants FOR ALL
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.user_profiles
    WHERE id = auth.uid() AND role = 'admin'
  )
);

-- Enrollments Policies
CREATE POLICY "Users can view own enrollments"
ON public.enrollments FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.participants
    WHERE id = enrollments.participant_id
    AND user_id = auth.uid()
  )
);

CREATE POLICY "Admins and trainers can view all enrollments"
ON public.enrollments FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.user_profiles
    WHERE id = auth.uid()
    AND role IN ('admin', 'trainer')
  )
);

-- Certificates Policies
CREATE POLICY "Users can view own certificates"
ON public.certificates FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.enrollments e
    JOIN public.participants p ON p.id = e.participant_id
    WHERE e.id = certificates.enrollment_id
    AND p.user_id = auth.uid()
  )
);

-- Tickets Policies
CREATE POLICY "Users can view own tickets"
ON public.tickets FOR SELECT
TO authenticated
USING (
  user_id = auth.uid() OR
  email = (SELECT email FROM auth.users WHERE id = auth.uid())
);

CREATE POLICY "Admins can view all tickets"
ON public.tickets FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.user_profiles
    WHERE id = auth.uid() AND role = 'admin'
  )
);
```

#### Fix #5: Add Security Headers

**File:** `next.config.js`

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  eslint: {
    ignoreDuringBuilds: false, // ‚úÖ Enable linting
  },
  typescript: {
    ignoreBuildErrors: false, // ‚úÖ Enable type checking
  },
  output: 'standalone',
  
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on'
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload'
          },
          {
            key: 'X-Frame-Options',
            value: 'SAMEORIGIN'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin'
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()'
          },
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-eval' 'unsafe-inline'",
              "style-src 'self' 'unsafe-inline'",
              "img-src 'self' data: https:",
              "font-src 'self' data:",
              "connect-src 'self' https://*.supabase.co",
              "frame-ancestors 'none'",
            ].join('; ')
          }
        ],
      },
    ]
  },
  
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'supabase.garuda-21.com',
        port: '',
        pathname: '/storage/v1/object/public/**',
      },
      {
        protocol: 'https',
        hostname: '*.supabase.co',
        port: '',
        pathname: '/storage/v1/object/public/**',
      },
    ],
  },
}

module.exports = nextConfig
```

#### Fix #6: Remove Sensitive Data from Logs

**File:** `lib/supabase-admin.ts`

```typescript
import { createClient } from '@supabase/supabase-js'
import { Database } from '@/types/database'

export function getSupabaseAdmin() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
  const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY

  if (!supabaseUrl) {
    throw new Error('Missing required environment variable: NEXT_PUBLIC_SUPABASE_URL')
  }

  if (!supabaseKey) {
    throw new Error('Missing required environment variable: SUPABASE_SERVICE_ROLE_KEY')
  }

  // ‚úÖ JANGAN log sensitive data!
  // Hanya log di development mode
  if (process.env.NODE_ENV === 'development') {
    console.log('‚úì Supabase admin client initialized')
  }

  return createClient<Database>(supabaseUrl, supabaseKey)
}
```

### Phase 2: High Priority Fixes (3-5 Hari) üü†

#### Fix #7: Implement Rate Limiting

**File:** `lib/rate-limit.ts` (NEW)

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { LRUCache } from 'lru-cache'

type RateLimitOptions = {
  interval: number
  uniqueTokenPerInterval: number
}

export function rateLimit(options: RateLimitOptions) {
  const tokenCache = new LRUCache({
    max: options.uniqueTokenPerInterval || 500,
    ttl: options.interval || 60000,
  })

  return {
    check: (limit: number, token: string) =>
      new Promise<void>((resolve, reject) => {
        const tokenCount = (tokenCache.get(token) as number[]) || [0]
        if (tokenCount[0] === 0) {
          tokenCache.set(token, tokenCount)
        }
        tokenCount[0] += 1

        const currentUsage = tokenCount[0]
        const isRateLimited = currentUsage >= limit

        return isRateLimited ? reject() : resolve()
      }),
  }
}

export function withRateLimit(
  handler: (req: NextRequest) => Promise<NextResponse>,
  limit: number = 10,
  windowMs: number = 60000
) {
  const limiter = rateLimit({
    interval: windowMs,
    uniqueTokenPerInterval: 500,
  })

  return async (req: NextRequest) => {
    const ip = req.ip || req.headers.get('x-forwarded-for') || 'unknown'
    
    try {
      await limiter.check(limit, ip)
    } catch {
      return NextResponse.json(
        { error: 'Too many requests. Please try again later.' },
        {
          status: 429,
          headers: {
            'X-RateLimit-Limit': limit.toString(),
            'X-RateLimit-Remaining': '0',
            'Retry-After': Math.ceil(windowMs / 1000).toString(),
          },
        }
      )
    }
    
    return await handler(req)
  }
}
```

**Apply ke sensitive routes:**
```typescript
// app/api/login/route.ts
import { withRateLimit } from '@/lib/rate-limit'

export const POST = withRateLimit(
  async (request) => {
    // Login logic
  },
  5, // Max 5 requests
  60000 // Per minute
)
```

#### Fix #8: Input Validation dengan Zod

**Install:**
```bash
npm install zod
```

**File:** `lib/validation.ts` (NEW)

```typescript
import { z } from 'zod'

export const emailSchema = z.string().email()
export const passwordSchema = z.string()
  .min(8, 'Password minimal 8 karakter')
  .max(100)
  .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/, 
    'Password harus mengandung huruf besar, huruf kecil, angka, dan karakter khusus')

export const signUpSchema = z.object({
  email: emailSchema,
  password: passwordSchema,
  fullName: z.string().min(2).max(100),
})

export const resetPasswordSchema = z.object({
  userId: z.string().uuid(),
})
```

**Usage:**
```typescript
export async function POST(request: NextRequest) {
  const body = await request.json()
  
  try {
    const validatedData = signUpSchema.parse(body)
    // Process validated data
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Validation failed', details: error.errors },
        { status: 400 }
      )
    }
  }
}
```

#### Fix #9: HTML Sanitization

**Install:**
```bash
npm install dompurify
npm install --save-dev @types/dompurify
```

**File:** `lib/sanitizer.ts` (NEW)

```typescript
import DOMPurify from 'isomorphic-dompurify'

export class Sanitizer {
  static html(input: string): string {
    return DOMPurify.sanitize(input, {
      ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p', 'br'],
      ALLOWED_ATTR: ['href'],
    })
  }
  
  static plainText(input: string): string {
    return DOMPurify.sanitize(input, {
      ALLOWED_TAGS: [],
    })
  }
}
```

---

## üìä PRIORITAS PERBAIKAN

### üî¥ CRITICAL (Fix Sebelum Pentest - 1-2 Hari)

1. ‚úÖ Implement API authentication middleware
2. ‚úÖ Fix file upload validation
3. ‚úÖ Enable middleware authentication
4. ‚úÖ Enable RLS policies
5. ‚úÖ Remove hardcoded passwords
6. ‚úÖ Remove sensitive data from logs

### üü† HIGH (Fix dalam 1 Minggu)

7. ‚úÖ Implement rate limiting
8. ‚úÖ Add security headers
9. ‚úÖ Input validation dengan Zod
10. ‚úÖ HTML sanitization
11. ‚úÖ Fix IDOR vulnerabilities
12. ‚úÖ Fix mass assignment

### üü° MEDIUM (Fix dalam 2 Minggu)

13. ‚úÖ CSRF protection
14. ‚úÖ Password policy enforcement
15. ‚úÖ Audit logging
16. ‚úÖ Error handling improvements
17. ‚úÖ CORS configuration

---

## ‚úÖ CHECKLIST PERSIAPAN PENETRATION TESTING

### Pre-Pentest Checklist

- [ ] **Authentication & Authorization**
  - [ ] ‚úÖ Semua API routes memiliki authentication
  - [ ] ‚úÖ Admin routes protected dengan role check
  - [ ] ‚úÖ Middleware authentication enabled
  - [ ] ‚úÖ RLS policies enabled dan tested

- [ ] **Input Validation**
  - [ ] ‚úÖ Schema validation (Zod) di semua endpoints
  - [ ] ‚úÖ HTML sanitization
  - [ ] ‚úÖ File upload validation (type, size, magic bytes)
  - [ ] ‚úÖ SQL injection prevention

- [ ] **API Security**
  - [ ] ‚úÖ Rate limiting di semua endpoints
  - [ ] ‚úÖ CSRF protection
  - [ ] ‚úÖ CORS configuration
  - [ ] ‚úÖ Request size limits

- [ ] **Security Headers**
  - [ ] ‚úÖ HSTS
  - [ ] ‚úÖ CSP
  - [ ] ‚úÖ X-Frame-Options
  - [ ] ‚úÖ X-Content-Type-Options

- [ ] **Data Protection**
  - [ ] ‚úÖ Tidak ada sensitive data di logs
  - [ ] ‚úÖ Tidak ada hardcoded credentials
  - [ ] ‚úÖ Environment variables secure

---

## üéØ KESIMPULAN

Aplikasi saat ini **TIDAK SIAP** untuk penetration testing. Terdapat **18 kerentanan critical** yang harus diperbaiki terlebih dahulu.

**Rekomendasi:**
1. **JANGAN** lakukan pentest di production
2. Perbaiki semua critical vulnerabilities terlebih dahulu
3. Setup staging environment untuk testing
4. Lakukan internal security review setelah fix
5. Baru lakukan penetration testing profesional

**Estimated Time to Fix:** 2-3 minggu full-time development

**Risk Level:** üî¥ **CRITICAL** - Aplikasi sangat rentan terhadap serangan

---

**Report Generated:** $(date)  
**Version:** 1.0  
**Status:** ‚ö†Ô∏è **FOR INTERNAL USE ONLY - CONFIDENTIAL**

